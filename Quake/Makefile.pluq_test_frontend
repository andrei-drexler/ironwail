# GNU Makefile for PluQ Test Frontend (Headless IPC Testing Tool)
# Minimal build - no SDL, no graphics, no audio, just stdin/stdout + IPC

# Enable/Disable user directories support
DO_USERDIRS=1

# Minimal SDL (headers only, stub functions)
USE_SDL2=1
USE_CURL=0
USE_CODEC_WAVE=0
USE_CODEC_FLAC=0
USE_CODEC_MP3=0
USE_CODEC_VORBIS=0
USE_CODEC_OPUS=0
USE_CODEC_MIKMOD=0
USE_CODEC_XMP=0
USE_CODEC_MODPLUG=0
USE_CODEC_UMX=0

# ---------------------------
# Helper functions
# ---------------------------

check_gcc = $(shell if echo | $(CC) $(1) -Werror -S -o /dev/null -xc - > /dev/null 2>&1; then echo "$(1)"; else echo "$(2)"; fi;)

# ---------------------------

HOST_OS = $(shell uname|sed -e s/_.*//|tr '[:upper:]' '[:lower:]')

DEBUG ?= 0

# ---------------------------
# build variables
# ---------------------------

CC ?= gcc
LINKER = $(CC)

STRIP ?= strip
PKG_CONFIG ?= pkg-config

CPUFLAGS=
LDFLAGS?=
DFLAGS ?=
CFLAGS ?= -Wall -Wno-trigraphs
CFLAGS += -DPLUQ_FRONTEND
CFLAGS += -D_FILE_OFFSET_BITS=64
CFLAGS += $(call check_gcc,-std=gnu11,)
CFLAGS += $(call check_gcc,-Werror=format,)
CFLAGS += $(CPUFLAGS)
ifneq ($(DEBUG),0)
DFLAGS += -DDEBUG
CFLAGS += -g
do_strip=
else
DFLAGS += -DNDEBUG
CFLAGS += -O2
CFLAGS += $(call check_gcc,-fweb,)
CFLAGS += $(call check_gcc,-frename-registers,)
cmd_strip=$(STRIP) $(1)
define do_strip
	@echo Stripping $(1) && \
	$(call cmd_strip,$(1));
endef
endif

ifeq ($(DO_USERDIRS),1)
CFLAGS += -DDO_USERDIRS=1
endif

# SDL2 configuration (headers only, minimal linking)
ifeq ($(USE_SDL2),1)
SDL_CONFIG ?= sdl2-config
else
SDL_CONFIG ?= sdl-config
endif
SDL_CFLAGS = $(shell $(SDL_CONFIG) --cflags)
SDL_LIBS   = $(shell $(SDL_CONFIG) --libs)

# nng and FlatCC libraries
NNG_LIBS = -Lnng_lib -lnng -lflatccrt
COMMON_LIBS = -ldl -lm -lpthread

LIBS = $(COMMON_LIBS) $(NNG_LIBS) $(SDL_LIBS)

# name of this makefile
MAKEFILE := Makefile.pluq_test_frontend

# ---------------------------
# objects
# ---------------------------

# Minimal object set - reuses host_pluq_frontend.o for initialization
OBJS = strlcat.o \
	strlcpy.o \
	cmd.o \
	common.o \
	console.o \
	cvar.o \
	cfgfile.o \
	crc.o \
	keys.o \
	mathlib.o \
	zone.o \
	wad.o \
	pluq.o \
	pluq_frontend.o \
	host_pluq_frontend.o \
	json.o \
	miniz.o \
	pl_linux.o \
	sys_sdl_unix.o \
	main_pluq_test_frontend.o \
	stubs_pluq_frontend.o

OBJDEPS := $(OBJS:%.o=%.d)

# ---------------------------
# targets / rules
# ---------------------------

.PHONY:	clean debug release

DEFAULT_TARGET = ironwail-pluq-test-frontend
all: $(DEFAULT_TARGET)

%.d:	%.c $(MAKEFILE)
	@echo "Generating dependencies for $<" && \
	$(CC) $(DFLAGS) -c $(CFLAGS) $(SDL_CFLAGS) -MM $< -MF $@ -MT $@
%.o:	%.c %.d $(MAKEFILE)
	@echo "Compiling $<" && \
	$(CC) $(DFLAGS) -c $(CFLAGS) $(SDL_CFLAGS) -o $@ $<

ironwail-pluq-test-frontend:	$(OBJS) $(MAKEFILE)
	@echo "Linking $@" && \
	$(LINKER) $(OBJS) $(LDFLAGS) $(LIBS) -o $@
	$(call do_strip,$@)

release:	ironwail-pluq-test-frontend
debug:
	$(error Use "make -f Makefile.pluq_test_frontend DEBUG=1")

clean: $(MAKEFILE)
	$(RM) *.o *.d $(DEFAULT_TARGET)

#---------------------------------------------------------------
# include dependencies (if not running 'clean' target)
#---------------------------------------------------------------

ifneq ($(strip $(MAKECMDGOALS)),clean)
ifneq ($(strip $(OBJDEPS)),)
-include $(OBJDEPS)
endif
endif
